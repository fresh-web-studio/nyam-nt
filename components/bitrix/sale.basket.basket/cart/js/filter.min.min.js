(function(){BX.namespace("BX.Sale.BasketFilter");BX.Sale.BasketFilter=function(a){this.component=a;this.activeFilterMode=false;this.filterTimer=null;this.mouseOverClearFilter=false;this.realShownItems=[];this.realSortedItems=[];this.realScrollTop=0;this.lastShownItemsHash="";this.currentFilter={query:"",similarHash:"",warning:false,notAvailable:false,delayed:false};if(this.component.useItemsFilter){this.bindEvents()}};BX.Sale.BasketFilter.prototype.bindEvents=function(){var a;var b=this.component.getEntity(this.component.getCacheNode(this.component.ids.itemListWrapper),"basket-filter");a=this.component.getEntity(b,"basket-filter-input");if(BX.type.isDomNode(a)){BX.bind(a,"focus",function(){b.style.flex=3});BX.bind(a,"blur",BX.delegate(function(){if(!this.mouseOverClearFilter){b.style.flex=""}},this));BX.bind(a,"keyup",BX.proxy(this.onFilterInput,this));BX.bind(a,"cut",BX.proxy(this.onFilterInput,this));BX.bind(a,"paste",BX.proxy(this.onFilterInput,this))}a=this.component.getEntity(b,"basket-filter-clear-btn");if(BX.type.isDomNode(a)){BX.bind(a,"mouseenter",BX.delegate(function(){this.mouseOverClearFilter=true},this));BX.bind(a,"mouseout",BX.delegate(function(){this.mouseOverClearFilter=false},this));BX.bind(a,"click",BX.delegate(function(){if(!this.filterInputEmpty()){this.clearFilterInput();this.onFilterChange()}b.style.flex=""},this))}};BX.Sale.BasketFilter.prototype.isActive=function(){return this.activeFilterMode};BX.Sale.BasketFilter.prototype.showFilterByName=function(a){if(!a){return}switch(a){case"not-available":this.showNotAvailableItemsFilter();break;case"delayed":this.showDelayItemsFilter();break;case"warning":this.showWarningItemsFilter();break;case"similar":this.showSimilarItemsFilter();break;case"all":default:this.clearAllFiltersExcept([]);this.onFilterChange()}};BX.Sale.BasketFilter.prototype.onFilterInput=function(){var a=BX.type.isDomNode(BX.proxy_context)?BX.util.trim(BX.proxy_context.value).toLowerCase():"";if(this.currentFilter.query!==a){this.currentFilter.query=a;this.onFilterChange()}};BX.Sale.BasketFilter.prototype.clearAllFiltersExcept=function(a){if(!a||!BX.type.isArray(a)){return}!BX.util.in_array("input",a)&&this.clearFilterInput();!BX.util.in_array("warning",a)&&this.clearWarningItemsFilter();!BX.util.in_array("delayed",a)&&this.clearDelayItemsFilter();!BX.util.in_array("not-available",a)&&this.clearNotAvailableItemsFilter();if(!BX.util.in_array("similar",a)){this.clearSimilarItemsFilter();this.component.showSimilarCount(false)}};BX.Sale.BasketFilter.prototype.filterInputEmpty=function(){return this.currentFilter.query.length===0};BX.Sale.BasketFilter.prototype.clearFilterInput=function(){this.currentFilter.query="";var a=this.component.getEntity(this.component.getCacheNode(this.component.ids.itemListWrapper),"basket-filter-input");if(BX.type.isDomNode(a)){a.value=""}};BX.Sale.BasketFilter.prototype.addWarningItemsFilter=function(){this.currentFilter.warning=true};BX.Sale.BasketFilter.prototype.clearWarningItemsFilter=function(){this.currentFilter.warning=false};BX.Sale.BasketFilter.prototype.showWarningItemsFilter=function(){if(!this.currentFilter.warning){this.clearAllFiltersExcept(["warning"]);this.addWarningItemsFilter();this.onFilterChange()}};BX.Sale.BasketFilter.prototype.addDelayItemsFilter=function(){this.currentFilter.delayed=true};BX.Sale.BasketFilter.prototype.clearDelayItemsFilter=function(){this.currentFilter.delayed=false};BX.Sale.BasketFilter.prototype.showDelayItemsFilter=function(){if(!this.currentFilter.delayed){this.clearAllFiltersExcept(["delayed"]);this.addDelayItemsFilter();this.onFilterChange()}};BX.Sale.BasketFilter.prototype.addNotAvailableItemsFilter=function(){this.currentFilter.notAvailable=true};BX.Sale.BasketFilter.prototype.clearNotAvailableItemsFilter=function(){this.currentFilter.notAvailable=false};BX.Sale.BasketFilter.prototype.showNotAvailableItemsFilter=function(){if(!this.currentFilter.notAvailable){this.clearAllFiltersExcept(["not-available"]);this.addNotAvailableItemsFilter();this.onFilterChange()}};BX.Sale.BasketFilter.prototype.addSimilarItemsFilter=function(a){this.currentFilter.similarHash=a.HASH};BX.Sale.BasketFilter.prototype.clearSimilarItemsFilter=function(){this.currentFilter.similarHash=""};BX.Sale.BasketFilter.prototype.showSimilarItemsFilter=function(){var a=this.component.getItemDataByTarget(BX.proxy_context);if(this.currentFilter.similarHash!==a.HASH){this.clearAllFiltersExcept(["similar"]);this.addSimilarItemsFilter(a);this.onFilterChange()}};BX.Sale.BasketFilter.prototype.getTimeoutDuration=function(){return this.component.duration.filterTimer};BX.Sale.BasketFilter.prototype.onFilterChange=function(){this.component.showItemsOverlay();if(this.currentFilter.query.length||this.currentFilter.similarHash.length||this.currentFilter.warning||this.currentFilter.notAvailable||this.currentFilter.delayed){clearTimeout(this.filterTimer);this.filterTimer=setTimeout(BX.proxy(this.enableFilterMode,this),this.getTimeoutDuration())}else{this.disableFilterMode()}};BX.Sale.BasketFilter.prototype.enableFilterMode=function(){var a;if(!this.activeFilterMode){this.activeFilterMode=true;this.realShownItems=BX.util.array_values(this.component.shownItems);this.realSortedItems=BX.util.array_values(this.component.sortedItems);this.realScrollTop=this.component.getDocumentScrollTop()}this.component.scrollToFirstItem();this.component.sortedItems=this.searchItems();a=JSON.stringify(this.component.sortedItems);if(this.lastShownItemsHash!==a){this.lastShownItemsHash=a;this.component.deleteBasketItems(BX.util.array_values(this.component.shownItems),false);if(this.component.sortedItems.length){this.component.initializeBasketItems();this.hideEmptyFilterResult()}else{this.showEmptyFilterResult()}if(this.currentFilter.similarHash.length){this.component.showSimilarCount(true)}}else{this.highlightFoundItems()}this.component.hideItemsOverlay()};BX.Sale.BasketFilter.prototype.disableFilterMode=function(){clearTimeout(this.filterTimer);this.lastShownItemsHash="";if(this.activeFilterMode){this.activeFilterMode=false;this.component.sortedItems=BX.util.array_values(this.realSortedItems);this.component.deleteBasketItems(BX.util.array_values(this.component.shownItems),false);this.hideEmptyFilterResult();this.component.editBasketItems(BX.util.array_values(this.realShownItems));window.scrollTo(0,this.realScrollTop)}this.component.hideItemsOverlay()};BX.Sale.BasketFilter.prototype.searchItems=function(){var b=[];for(var c=0;c<this.realSortedItems.length;c++){var a=this.component.items[this.realSortedItems[c]];if(a&&this.searchItemMatch(a)){b.push(a.ID)}}return b};BX.Sale.BasketFilter.prototype.highlightFoundItems=function(){if(!this.activeFilterMode){return}for(var a in this.component.shownItems){if(this.component.shownItems.hasOwnProperty(a)){this.highlightSearchMatch(this.component.items[this.component.shownItems[a]])}}};BX.Sale.BasketFilter.prototype.searchItemMatch=function(c){var g=false,b=false;if(this.currentFilter.notAvailable){b=!!c.NOT_AVAILABLE;if(!b){return g}}else{if(this.currentFilter.delayed){b=!!c.DELAYED;if(!b){return g}}else{if(this.currentFilter.warning){b=BX.util.in_array(c.ID,this.component.warningItems);if(!b){return g}}else{if(BX.type.isNotEmptyString(this.currentFilter.similarHash)){b=this.currentFilter.similarHash===c.HASH;if(!b){return g}}}}}if(BX.type.isNotEmptyString(this.currentFilter.query)){if(c.NAME.toLowerCase().indexOf(this.currentFilter.query)!==-1){g="NAME"}if(!g){var f=parseFloat(this.currentFilter.query);if(!isNaN(f)){if(parseFloat(c.PRICE)===f){g="PRICE"}else{if(parseFloat(c.SUM_PRICE)===f){g="SUM_PRICE"}}}}if(!g&&this.currentFilter.query.length>=3){if(c.PRICE_FORMATED.toLowerCase().indexOf(this.currentFilter.query)!==-1){g="PRICE"}else{if(c.SUM_PRICE_FORMATED.toLowerCase().indexOf(this.currentFilter.query)!==-1){g="SUM_PRICE"}}}var d,a;if(!g&&c.PROPS.length){for(d in c.PROPS){if(c.PROPS.hasOwnProperty(d)&&BX.type.isNotEmptyString(c.PROPS[d].VALUE)){a=c.PROPS[d].VALUE.toLowerCase();if(a===this.currentFilter.query||this.currentFilter.query.length>=3&&a.indexOf(this.currentFilter.query)!==-1){g="PROPS";break}}}}if(!g&&c.COLUMN_LIST.length){for(d in c.COLUMN_LIST){if(c.COLUMN_LIST.hasOwnProperty(d)&&BX.type.isNotEmptyString(c.COLUMN_LIST[d].VALUE)){a=c.COLUMN_LIST[d].VALUE.toLowerCase();if(a===this.currentFilter.query||this.currentFilter.query.length>=3&&a.indexOf(this.currentFilter.query)!==-1){g="COLUMNS";break}}}}}else{if(b){g=true}}return g};BX.Sale.BasketFilter.prototype.highlightSearchMatch=function(c){var g=this.searchItemMatch(c);if(g){var b,f,d,a;switch(g){case"NAME":b=this.component.getEntity(BX(this.component.ids.item+c.ID),"basket-item-name");if(BX.type.isDomNode(b)){b.innerHTML=c.NAME.replace(new RegExp("(.*)("+this.currentFilter.query.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+")(.*)","gi"),function(j,l,h,k){return BX.util.htmlspecialchars(l)+'<span class="basket-item-highlighted">'+BX.util.htmlspecialchars(h)+"</span>"+BX.util.htmlspecialchars(k)})}break;case"PRICE":b=BX(this.component.ids.price+c.ID);BX.addClass(b,"basket-item-highlighted");break;case"SUM_PRICE":b=BX(this.component.ids.sumPrice+c.ID);BX.addClass(b,"basket-item-highlighted");break;case"PROPS":b=this.component.getEntities(BX(this.component.ids.item+c.ID),"basket-item-property-value");for(f=0;f<b.length;f++){a=b[f].getAttribute("data-property-code");for(d in c.PROPS){if(c.PROPS.hasOwnProperty(d)&&c.PROPS[d].CODE===a){b[f].innerHTML=c.PROPS[d].VALUE.replace(new RegExp("("+this.currentFilter.query+")","gi"),'<span class="basket-item-highlighted">$1</span>')}}}break;case"COLUMNS":b=this.component.getEntities(BX(this.component.ids.item+c.ID),"basket-item-property-column-value");for(f=0;f<b.length;f++){a=b[f].getAttribute("data-column-property-code");for(d in c.COLUMN_LIST){if(c.COLUMN_LIST.hasOwnProperty(d)&&c.COLUMN_LIST[d].CODE===a){b[f].innerHTML=c.COLUMN_LIST[d].VALUE.replace(new RegExp("("+this.currentFilter.query+")","gi"),'<span class="basket-item-highlighted">$1</span>')}}}break}}};BX.Sale.BasketFilter.prototype.showEmptyFilterResult=function(){var a=this.component.getCacheNode(this.component.ids.itemList);if(BX.type.isDomNode(a)&&a.clientHeight>=500){var b=this.component.getCacheNode(this.component.ids.itemListEmptyResult);if(BX.type.isDomNode(b)){b.style.display=""}}};BX.Sale.BasketFilter.prototype.hideEmptyFilterResult=function(){var a=this.component.getCacheNode(this.component.ids.itemListEmptyResult);if(BX.type.isDomNode(a)){a.style.display="none"}}})();