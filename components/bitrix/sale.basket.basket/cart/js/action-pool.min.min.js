(function(){BX.namespace("BX.Sale.BasketActionPool");BX.Sale.BasketActionPool=function(b){this.component=b;this.requestProcessing=false;this.updateTimer=null;this.isBasketRefreshed=this.component.params.DEFERRED_REFRESH!=="Y";this.needFullRecalculation=this.component.params.DEFERRED_REFRESH==="Y";this.pool={};this.lastActualPool={};this.approvedAction=["QUANTITY","DELETE","RESTORE","DELAY","OFFER","MERGE_OFFER"];this.switchTimer()};BX.Sale.BasketActionPool.prototype.setRefreshStatus=function(b){this.isBasketRefreshed=!!b};BX.Sale.BasketActionPool.prototype.getRefreshStatus=function(){return this.isBasketRefreshed};BX.Sale.BasketActionPool.prototype.isItemInPool=function(b){return !!this.pool[b]};BX.Sale.BasketActionPool.prototype.clearLastActualQuantityPool=function(b){this.lastActualPool[b]&&delete this.lastActualPool[b].QUANTITY};BX.Sale.BasketActionPool.prototype.checkItemPoolBefore=function(b){if(!b){return}this.pool[b]=this.pool[b]||{}};BX.Sale.BasketActionPool.prototype.checkItemPoolAfter=function(b){if(!b||!this.pool[b]){return}if(Object.keys(this.pool[b]).length===0){delete this.pool[b]}};BX.Sale.BasketActionPool.prototype.addCoupon=function(b){this.pool.COUPON=b;this.switchTimer()};BX.Sale.BasketActionPool.prototype.removeCoupon=function(b){this.checkItemPoolBefore("REMOVE_COUPON");this.pool.REMOVE_COUPON[b]=b;this.switchTimer()};BX.Sale.BasketActionPool.prototype.changeQuantity=function(f,d,e){this.checkItemPoolBefore(f);if((this.lastActualPool[f]&&this.lastActualPool[f].QUANTITY!==d)||(!this.lastActualPool[f]&&d!==e)){this.pool[f].QUANTITY=d}else{this.pool[f]&&delete this.pool[f].QUANTITY}this.checkItemPoolAfter(f);this.switchTimer()};BX.Sale.BasketActionPool.prototype.deleteItem=function(b){this.checkItemPoolBefore(b);if(this.pool[b].RESTORE){delete this.pool[b].RESTORE}else{this.pool[b].DELETE="Y"}this.checkItemPoolAfter(b);this.switchTimer()};BX.Sale.BasketActionPool.prototype.restoreItem=function(c,d){this.checkItemPoolBefore(c);if(this.pool[c].DELETE==="Y"){delete this.pool[c].DELETE}else{this.pool[c].RESTORE=d}this.checkItemPoolAfter(c);this.switchTimer()};BX.Sale.BasketActionPool.prototype.addDelayed=function(b){this.checkItemPoolBefore(b);this.pool[b].DELAY="Y";this.checkItemPoolAfter(b);this.switchTimer()};BX.Sale.BasketActionPool.prototype.removeDelayed=function(b){this.checkItemPoolBefore(b);this.pool[b].DELAY="N";this.checkItemPoolAfter(b);this.switchTimer()};BX.Sale.BasketActionPool.prototype.changeSku=function(f,d,e){if(JSON.stringify(d)!==JSON.stringify(e)){this.checkItemPoolBefore(f);this.pool[f].OFFER=d}else{this.pool[f]&&delete this.pool[f].OFFER;this.checkItemPoolAfter(f)}this.switchTimer()};BX.Sale.BasketActionPool.prototype.mergeSku=function(b){this.checkItemPoolBefore(b);this.pool[b].MERGE_OFFER="Y";this.switchTimer()};BX.Sale.BasketActionPool.prototype.switchTimer=function(){clearTimeout(this.updateTimer);if(this.isProcessing()){return}if(this.isPoolEmpty()){this.component.editPostponedBasketItems();this.component.fireCustomEvents()}if(!this.isPoolEmpty()){this.updateTimer=setTimeout(BX.proxy(this.trySendPool,this),300)}else{if(!this.getRefreshStatus()){this.trySendPool()}}};BX.Sale.BasketActionPool.prototype.trySendPool=function(){if(this.isPoolEmpty()&&this.getRefreshStatus()){return}this.doProcessing(true);if(!this.isPoolEmpty()){this.component.sendRequest("recalculateAjax",{basket:this.getPoolData()});this.lastActualPool=this.pool;this.pool={}}else{if(!this.getRefreshStatus()){this.component.sendRequest("refreshAjax",{fullRecalculation:this.needFullRecalculation?"Y":"N"});this.needFullRecalculation=false}}};BX.Sale.BasketActionPool.prototype.getPoolData=function(){var f={},e=this.pool;if(e.COUPON){f.coupon=e.COUPON;delete e.COUPON}if(e.REMOVE_COUPON){f.delete_coupon=e.REMOVE_COUPON;delete e.REMOVE_COUPON}for(var g in e){if(e.hasOwnProperty(g)){for(var h in e[g]){if(e[g].hasOwnProperty(h)&&BX.util.in_array(h,this.approvedAction)){f[h+"_"+g]=e[g][h]}}}}return f};BX.Sale.BasketActionPool.prototype.isPoolEmpty=function(){return Object.keys(this.pool).length===0};BX.Sale.BasketActionPool.prototype.doProcessing=function(b){this.requestProcessing=b===true;if(this.requestProcessing){this.component.startLoader()}else{this.component.endLoader()}};BX.Sale.BasketActionPool.prototype.isProcessing=function(){return this.requestProcessing===true}})();